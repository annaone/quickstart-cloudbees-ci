# Post Deployment Steps

## Step 1. Activate CloudBees CI
1. Open the URL from step 2.9 in the previous section. You should see an activation screen, as shown in **figure 3**.

image::https://github.com/ikurtz/quickstart-cloudbees-ci/blob/doc-edits/docs/images/unlock-cbci.png[CloudBees CI Activation Screen]

1. Obtain the initialAdminPassword by accessing the EKS cluster from the bastion host. To log in to the bastion host, find the BastionIP in the Outputs tab of the base CloudBees CI stack. Then connect from your local terminal to the bastion host by using SSH, with a command similar to the following:

* `chmod 400 ~/cloudbees-core.pem && ssh -i ~/cloudbees-core.pem ec2-
user@3.93.136.235`

* where `cloudbees-core.pem` refers to the key pair you created earlier in this guide.

2. Use **kubectl** on the bastion host to print the **initialAdminPassword** with the following command:

* `kubectl -n cloudbees-core exec cjoc-0 -- cat /var/jenkins_home/secrets/initialAdminPassword`

3. Use the **initialAdminPassword** to proceed with the Getting Started wizard.
4. Choose the **Request a trial license** button and fill in the form to use CloudBees CI for 15 days, free of charge.
5. Choose **Install suggested plugins** to obtain the recommended set of plugins, or choose **Select plugins to install** to customize the installation, if you’re an advanced user.
6. If an incremental upgrade is available, we recommend that you choose the **Install** button to install it.
7. Create an administrator or choose **Continue as admin** to proceed with the default administrator account. (The administrator’s name is **admin**, and the password is determined by **initialAdminPassword**.)
8. Ensure that the Jenkins URL looks correct on the **Instance Configuration** screen, 
and then choose **Save and Finish**.
9. If required, choose the **Restart** button to restart Operations Center and complete the Getting Started wizard.

## Getting started with CloudBees CI
Before you use CloudBees CI on AWS, review the https://go.cloudbees.com/docs/cloudbees-core/cloud-reference-architecture/ra-for-eks/[CloudBees CI Reference Architecture^] for Amazon EKS. You can also use the free, self-paced https://go.cloudbees.com/training/index.html[training^] offered by CloudBees to learn best practices for administration, usage, CI/CD pipeline development, and more.

The popularity of Jenkins is due, in large part, to the plugins ecosystem. You can add new functionality with plugins. For example, you can integrate CloudBees CI with the following tools and services:

* Git, to check out code every time a developer commits to a branch
* Maven and JUnit, to build a Java application and publish the test results
* AWS Elastic Beanstalk, to deploy the Java application

Although it is possible to add plugins to Operations Center, this component of the CloudBees CI architecture serves a different purpose than a Managed Master and offers a limited set of plugins in its plugin update center. To make full use of CloudBees CI, provision a Managed Controller before creating the first CI/CD pipeline. These topics are covered in a https://go.cloudbees.com/docs/cloudbees-core/cloud-admin-guide/getting-started/[getting started^] guide on the CloudBees website.

## Targeting agent pools from a pipeline

> **Note**
> This section assumes that you are familiar with Pipeline and Jenkinsfile. If you are unfamiliar with them, see https://jenkins.io/doc/book/pipeline/jenkinsfile/[Using a Jenkinsfile^].

If no additional configuration is provided, agent pods launched by the Kubernetes plugin run in the Masters partition of the EKS cluster. To validate this behavior, run the following commands on the bastion host while a pipeline is running:

`#display nodes with partition info
kubectl get nodes -o custom-columns=NAME:.metadata.name,PARTITION:.metadata.labels.partition --
sort-by=.metadata.labels.partition

#display pods with node info
kubectl get pod -n cloudbees-core -o=custom-columns=NAME:.metadata.name,STATUS:.status.phase,NODE:.spec.nodeName`

Agents are resource intensive, so we recommend separating them from masters. The Partner Solution provides a method for doing so with the additional agent pools.

CloudBees CI enables you to https://go.cloudbees.com/docs/cloudbees-core/cloud-admin-guide/agents/#managing-agents[configure a Kubernetes agent^] globally in Operations Center and to set default values for pods and containers that are launched by the Kubernetes shared cloud. You can use these features to enforce which partition an agent runs on, individually or globally.

To configure agents to run on a given partition, you must know how to https://kubernetes.io/docs/concepts/configuration/assign-pod-node/[Assign Pods to Nodes^] and use https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/[Taints and Tolerations^] in Kubernetes, which are demonstrated in the following example.

One way to define an agent pod is to place its Kubernetes YAML configuration directly into a `Jenkinsfile`, instead of configuring the agent through the UI. This approach stores the entire CI/CD pipeline (including the agent definition) in source control. This has the added benefits of code reviews and a full audit trail of changes.

Follow these steps to create a basic pipeline that runs in the Regular agents partition:

1. On a Managed Controller, choose **New Item**.
2. From the list of item types, choose **Pipeline**, enter an item name (for example, `declarative-pipeline-spot-agents`), and then choose **OK**.
3. Scroll down to the Pipeline section, and copy-paste the contents of `declarative-pipeline-regular-agents.groovy` into the **Script** text area.

> **Note**
> Repeat steps 1–3 with `declarative-pipeline-spot-agents.groovy` to set up the example that uses the Spot agents partition if you've selected this node partition as a part of deploying the Partner Solution. Refer to the `nodeSelector` and `tolerations` section of each script, and the Kubernetes documentation, to fully 
understand how pods are assigned to cluster partitions.

4. Choose **Save**, and then choose **Build Now** on the resulting screen.

You now have a CI/CD pipeline that runs at a low cost on Amazon EC2 Instances. View the **Console Output** (logs) by following the link on the build page, or by choosing the flashing gray ball (or the progress bar) on the running build. 

To validate that the agent is running on the desired cluster partition, run the `kubectl` commands from earlier in this section on the bastion host.

## Upgrades
Administrators can upgrade the Partner Solution at any time when updates are available from CloudBees, Amazon Web Services, and the open-source community. The most common updates can include new versions of CloudBees CI and Kubernetes, bug fixes, or new 
features. We strongly advise that users keep their environment up-to-date and plan maintenance windows accordingly.

Watch the https://github.com/aws-quickstart/quickstart-cloudbees-core[aws-quickstart/quickstart-cloudbees-core^] and https://github.com/aws-quickstart/quickstart-amazon-eks/tree/master[aws-quickstart/quickstartamazon-eks^] GitHub repositories to get notified when updates are available.

Upgrading the Partner Solution means applying the latest AWS CloudFormation templates. When new templates are applied, AWS CloudFormation compares what’s running to what’s defined in the new templates. AWS CloudFormation then creates, replaces, updates, or deletes resources until all resources are aligned with the new template. For more information about how AWS CloudFormation handles updates, see https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/using-cfn-updating-stacks.html[AWS CloudFormation Stack Updates^].

When AWS adopts new versions of Kubernetes on EKS, both preceding repositories are updated. When CloudBees releases new versions of CloudBees CI, only the `quickstart-cloudbees-core repository` is updated.

When the Partner Solution is upgraded, many things can happen. Running EC2 instances may be 
terminated and replaced with new AMI versions, or Operations Center will be unavailable for a short time while its Docker image is replaced. The behavior of the environment during the upgrade ultimately depends on what has changed in the underlying AWS CloudFormation templates.

To upgrade the Partner Solution to a new version, do the following:

1. In the AWS CloudFormation console, navigate to the base CloudBees CI stack and choose **Update**. In earlier versions of the CloudFormation UI, this button is found in the **Actions** menu.
2. On the **Update stack** screen, choose **Replace current template**, enter the S3 URL 
for the new template, and then choose **Next**.

> **Note** Based on your deployment type, choose one of the following options:
> https://fwd.aws/3j4jq[Deploy CloudBees CI into a new VPC^]
> https://fwd.aws/YQ9xp[Deploy CloudBees CI into an existing VPC^]

3. On the **Specify stack details** page, your existing parameter values are displayed, and 
the template might add new options. You can change many of the values on this screen, 
but we recommend that you leave existing parameters as is to reduce the number of 
moving pieces during the upgrade. You can usually change parameter values after the 
upgrade is complete. Choose **Next**.

> **Note**
There is no parameter for the CloudBees CI version. The CloudBees CI version is defined in `cloudbees-core-workload.template.yaml`. If the new template contains a new version of Operations Center, Operations Center is upgraded to the 
new version. Managed Controllers can be upgraded later by choosing the new Docker image version on the Managed Master configuration screen in Operations Center. Consider using a https://docs.cloudbees.com/docs/cloudbees-core/latest/cloud-admin-guide/cluster-operations[Cluster operations^] to upgrade all Managed Controllers at once, after 
the AWS CloudFormation upgrade.

4. On the **Configure stack options** page, leave everything as is, unless changes are needed, and then choose **Next**.
5. On the **Review page**, scroll down to **Capabilities**, select all the boxes, and then choose **Update Stack**.
6. Monitor the **Events** tab on each AWS CloudFormation stack to see what is changing during the upgrade. Also, monitor the Amazon EC2 console to observe, for example, EC2 instances being replaced one-by-one, as a new version of Kubernetes is applied.

## Security
The Partner Solution architecture for CloudBees CI implements AWS best practices for security, including deployment into private subnets and https://en.wikipedia.org/wiki/Principle_of_least_privilege[least privilege^] access. In CloudBees CI, an administrator must consider who can access the system and what they are authorized to do.
In addition, CI/CD workloads often require credentials to access other systems for specific
tasks. These credentials must be accessed securely by end users. For more information, see
https://go.cloudbees.com/docs/cloudbees-core/cloud-admin-guide/securing/[CloudBees Core security guide^].